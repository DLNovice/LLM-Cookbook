> ä»æœ€è¿‘çš„ä¸€äº›é¢ç»æ¥çœ‹ï¼Œä¸»è¦é—®ä¸¤ä¸ªæ–¹é¢ï¼švLLMæ ¸å¿ƒæŠ€æœ¯ + vLLMæ¨ç†åŠ é€Ÿæ–¹æ³•

å®˜æ–¹ç¨³å®šç‰ˆæ–‡æ¡£ï¼šhttps://docs.vllm.ai/en/stable/usage/index.html



TODOï¼š

- [ã€ŠInside vLLM: Anatomy of a High-Throughput LLM Inference Systemã€‹](https://mp.weixin.qq.com/s/NNLuVYjk_K8QqM9mXbxCPg)
  - æˆ‘ä»¬ä»åŸºç¡€çš„å¼•æ“æ ¸å¿ƒï¼ˆUniprocExecutorï¼‰å¼€å§‹ï¼Œæ·»åŠ äº†è¯¸å¦‚æŠ•æœºè§£ç ï¼ˆspeculative decodingï¼‰å’Œå‰ç¼€ç¼“å­˜ï¼ˆprefix cachingï¼‰ç­‰é«˜çº§åŠŸèƒ½ã€‚
  - éšåæ‰©å±•åˆ° MultiProcExecutorï¼ˆTP/PP > 1ï¼‰ï¼Œæœ€ç»ˆå®ç°åˆ†å¸ƒå¼æ‰©å±•ï¼Œå°†æ‰€æœ‰å†…å®¹å°è£…åœ¨å¼‚æ­¥å¼•æ“å’Œåˆ†å¸ƒå¼æœåŠ¡æ ˆä¸­ï¼šæœ€åä»‹ç»äº†å¦‚ä½•è¡¡é‡ç³»ç»Ÿæ€§èƒ½ã€‚





# vLLMæ ¸å¿ƒæŠ€æœ¯

å‚è€ƒä¸€äº›ç»¼è¿°ï¼š

- [Inside vLLM: Anatomy of a High-Throughput LLM Inference System](https://blog.vllm.ai/2025/09/05/anatomy-of-vllm.html)
- [ZOMIä½¬ - å¤§æ¨¡å‹æ¨ç†åŠ é€Ÿ](https://infrasys-ai.github.io/aiinfra-docs/05Infer02InferSpeedUp/README.html)
- [AI Infra å­¦ä¹ ä¼šè®®](https://github.com/cr7258/ai-infra-learning/tree/main)

æ ¸å¿ƒæŠ€æœ¯æ¦‚è¿°ï¼š

- å†…å­˜ä¼˜åŒ– Page Attention
- è¿ç»­æ‰¹å¤„ç† Continuous Batching
- å†…å­˜æ± ä¼˜åŒ–

å‚è€ƒæ¶æ„å›¾ï¼ˆæ¥è‡ªZOMIçš„AI Infraæ•™ç¨‹ï¼‰ï¼š

<img src="./assets/image-20251029104847213.png" alt="image-20251029104847213" style="zoom:50%;" />

## 1ï¼‰æ¨ç†åŠ é€Ÿ

### KV Cache

> ä¸ºäº†è§£å†³Decodeé˜¶æ®µçš„é—®é¢˜ï¼Œäº§ç”Ÿäº†KV Cacheçš„æ¦‚å¿µ

æ¦‚å¿µï¼š

- åŸç†è®²è§£ï¼šhttps://www.bilibili.com/video/BV17CPkeEEzk
- ä¸ºä»€ä¹ˆæ²¡æœ‰ Q Cacheï¼Ÿ

KV Cache ç“¶é¢ˆ

- TODO



### FlashAttention

å‚è€ƒï¼š

- [çŒ›çŒ¿ï¼šå›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ï¼šFlashAttention V1ï¼Œä»ç¡¬ä»¶åˆ°è®¡ç®—é€»è¾‘](https://zhuanlan.zhihu.com/p/669926191)
- [çŒ›çŒ¿ï¼šå›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ï¼šFlash Attention V2ï¼Œä»åŸç†åˆ°å¹¶è¡Œè®¡ç®—](https://zhuanlan.zhihu.com/p/691067658)



### PageAttention

å‚è€ƒï¼š

- [çŒ›çŒ¿ï¼šå›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ä¹‹ï¼švLLMæ ¸å¿ƒæŠ€æœ¯PagedAttentionåŸç†](https://zhuanlan.zhihu.com/p/691038809)



3Blue - TransformeråŠAttentionï¼šhttps://www.bilibili.com/video/BV1TZ421j7Ke



æ¦‚å¿µï¼š

- **PagedAttention** æ˜¯ä¸€ç§ä¼˜åŒ– **æ³¨æ„åŠ›æœºåˆ¶ï¼ˆAttentionï¼‰** çš„æŠ€æœ¯ï¼Œç‰¹åˆ«ç”¨äº **å¤§è§„æ¨¡æ¨ç†ï¼ˆinferenceï¼‰** é˜¶æ®µï¼Œä»¥æé«˜å†…å­˜åˆ©ç”¨ç‡å’Œè®¡ç®—æ•ˆç‡ã€‚
- PagedAttention çš„æ ¸å¿ƒçµæ„Ÿæ¥æºäºæ“ä½œç³»ç»Ÿä¸­çš„ **åˆ†é¡µï¼ˆpagingï¼‰å†…å­˜ç®¡ç†**ï¼šå°†å¤§å—çš„å†…å­˜åˆ’åˆ†ä¸º**å°é¡µï¼ˆpagesï¼‰**ï¼Œå¹¶ç”¨é¡µè¡¨ï¼ˆPage Tableï¼‰æ¥åŠ¨æ€ç®¡ç†è®¿é—®å’Œæ˜ å°„ã€‚

ä¸»è¦æ€è·¯ï¼š

- **å°† Key/Value ç¼“å­˜æ‹†åˆ†ä¸ºå›ºå®šå¤§å°çš„â€œé¡µâ€ï¼ˆå¦‚å¤§å°ä¸º 1K Tokenï¼‰**ã€‚
- **ä½¿ç”¨é¡µè¡¨ç»“æ„æ¥æ˜ å°„æ¯ä¸ªåºåˆ—çš„å®é™…ä¸Šä¸‹æ–‡ä½ç½®åˆ°å¯¹åº”çš„ K/V é¡µ**ã€‚
- æ¨ç†æ—¶ï¼Œä¸å†ä¸ºæ¯ä¸ªåºåˆ—åˆ†é…å®Œæ•´çš„å¤§å¼ é‡ï¼Œè€Œæ˜¯é€šè¿‡é¡µè¡¨åŠ¨æ€å¼•ç”¨å¤šä¸ªå…±äº«æˆ–ç‹¬ç«‹çš„é¡µã€‚



ä¸ FlashAttention çš„å¯¹æ¯”

| ç‰¹æ€§             | PagedAttention       | FlashAttention                 |
| ---------------- | -------------------- | ------------------------------ |
| ç›®æ ‡é˜¶æ®µ         | æ¨ç†é˜¶æ®µ             | è®­ç»ƒ & æ¨ç†é˜¶æ®µ                |
| å…³æ³¨ç‚¹           | å†…å­˜å¸ƒå±€ä¸ç¼“å­˜ç®¡ç†   | æ³¨æ„åŠ›è®¡ç®—çš„å†…æ ¸åŠ é€Ÿ           |
| æ˜¯å¦åˆ†é¡µæœºåˆ¶     | âœ… æ˜¯                 | âŒ å¦                           |
| æ˜¯å¦é¿å…é‡å¤å¤åˆ¶ | âœ… æ˜¯                 | éƒ¨åˆ†                           |
| ä½¿ç”¨æ–¹å¼         | æ¡†æ¶çº§ç®¡ç†ï¼ˆKVç¼“å­˜ï¼‰ | ç®—å­çº§ä¼˜åŒ–ï¼ˆattention kernelï¼‰ |



ä¸æ™®é€šAttentionå¯¹æ¯”

| æ¯”å–»                 | æ™®é€š Attention                  | PagedAttention              |
| -------------------- | ------------------------------- | --------------------------- |
| ğŸ’­ çœ‹å‰é¢çš„å†…å®¹       | æ¯æ¬¡éƒ½æŠŠæ•´æœ¬ä½œæ–‡é‡æ–°ç¿»ä¸€éğŸ“–     | åªç¿»éœ€è¦çš„å‡ é¡µğŸ“„             |
| ğŸ“š ä½œæ–‡è¶Šé•¿æ€ä¹ˆåŠ     | è¶Šæ¥è¶Šæ…¢ï¼Œè¶Šæ¥è¶Šç´¯ğŸ˜©             | æ²¡å…³ç³»ï¼Œåªå¢åŠ å‡ é¡µå°±è¡ŒğŸ™‚     |
| ğŸ‘¥ å¤šäººä¸€èµ·å†™ä½œæ–‡     | æ¯ä¸ªäººéƒ½è¦å¸¦ä¸€æ•´æœ¬è‡ªå·±çš„ä½œæ–‡ğŸ“šğŸ“šğŸ“š | åªå¸¦ä¸€å¼ â€œé¡µç è¡¨â€+éœ€è¦çš„é¡µğŸ“‘ğŸ“‘ |
| ğŸ§  å ç”¨çš„è„‘å­ï¼ˆå†…å­˜ï¼‰ | å¾ˆå¤§ï¼Œå®¹æ˜“è£…ä¸ä¸‹                | å°è€Œèªæ˜ï¼Œè£…å¾—å¤š            |
| ğŸš€ é€Ÿåº¦               | æ…¢                              | å¿«                          |



## 2ï¼‰æ¶æ„è°ƒåº¦åŠ é€Ÿ

### 1ã€åˆ†ç¦»å¼æ¨ç†æ¶æ„

å‚è€ƒï¼š

- [çŒ›çŒ¿ï¼šå›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ï¼šåˆ†ç¦»å¼æ¨ç†æ¶æ„1ï¼Œä»DistServeè°ˆèµ·](https://zhuanlan.zhihu.com/p/706761664)
- [çŒ›çŒ¿ï¼šå›¾è§£å¤§æ¨¡å‹è®¡ç®—åŠ é€Ÿç³»åˆ—ï¼šåˆ†ç¦»å¼æ¨ç†æ¶æ„2ï¼Œæ¨¡ç³Šåˆ†ç¦»ä¸åˆå¹¶è¾¹ç•Œçš„chunked-prefills](https://zhuanlan.zhihu.com/p/710165390)



#### Chunked-Prefills

**Chunked Prefills** æ˜¯ä¸€ç§ç”¨äºåŠ é€Ÿ **é•¿ä¸Šä¸‹æ–‡è¾“å…¥**åœ¨å¤§è¯­è¨€æ¨¡å‹æ¨ç†ä¸­çš„ä¼˜åŒ–æŠ€æœ¯ã€‚å®ƒé€šè¿‡**å°†é•¿è¾“å…¥ï¼ˆpromptï¼‰åˆ†å—ï¼ˆchunkï¼‰å¤„ç†**ï¼Œä»¥ä¾¿æ›´é«˜æ•ˆåœ°å¡«å…… Key/Value ç¼“å­˜ï¼Œ**èŠ‚çœæ˜¾å­˜ã€æé«˜ååé‡**ï¼Œå°¤å…¶é€‚ç”¨äºå¤šç”¨æˆ·å¹¶å‘å’Œå¤§ä¸Šä¸‹æ–‡çª—å£çš„åœºæ™¯ã€‚

åšæ³•ï¼š

1. **å°†è¾“å…¥ Prompt åˆ†æˆå¤šä¸ªå° chunk**ï¼ˆå¦‚æ¯æ¬¡å¤„ç† 128 æˆ– 256 ä¸ª tokenï¼‰ã€‚
2. **åˆ†æ‰¹å¤„ç†è¿™äº› chunk**ï¼Œæ¯æ¬¡åªæ›´æ–°ä¸€éƒ¨åˆ† Key/Value ç¼“å­˜ã€‚
3. **é€å—æ‰§è¡Œå‰å‘ä¼ æ’­**ï¼Œé€æ­¥å®Œæˆæ•´ä¸ª prompt çš„é¢„å¡«å……è¿‡ç¨‹ã€‚
4. æœ€åå†è¿›è¡Œæ­£å¼çš„ token ç”Ÿæˆé˜¶æ®µï¼ˆdecodeï¼‰ã€‚



| åå­—             | å®ƒåšäº†ä»€ä¹ˆ                     | æ¯”å–»                         |
| ---------------- | ------------------------------ | ---------------------------- |
| Chunked Prefills | æŠŠé•¿è¾“å…¥åˆ†æ®µå¤„ç†ï¼Œæ…¢æ…¢å­˜è¿›è„‘å­ | æ¬ä¹¦æ—¶åˆ†å¤šæ¬¡æ¬ï¼Œä¸ä¸€æ¬¡å…¨æ‹¿   |
| ä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿ | é¿å…å¤ªæ…¢ã€å¤ªé‡æˆ–çˆ†ç‚¸ï¼ˆOOMï¼‰    | æ‹¿å¤ªå¤šä¹¦ä¼šæ‰­åˆ°è…°ï¼Œåˆ†æ‰¹æ›´å®‰å…¨ |
| æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ     | å¿«ã€çœåŠ›ï¼Œè¿˜èƒ½å¤šä¸ªåŒå­¦ä¸€èµ·åš   | å¯ä»¥å’ŒåŒå­¦åŒæ—¶æ¬æ›´å¤šçš„ä¹¦ ğŸ“šğŸ“šğŸ“š |



#### Disaggregated Prefill

ä¼ è¯´ä¸­çš„DPåˆ†ç¦»ã€‚**Disaggregated Prefill** æ˜¯ä¸€ç§åœ¨å¤§è¯­è¨€æ¨¡å‹æ¨ç†é˜¶æ®µè¿›è¡Œä¼˜åŒ–çš„æ–¹æ³•ï¼Œå®ƒå°†ä¼ ç»Ÿæ¨ç†æµç¨‹ä¸­ä¸€æ¬¡æ€§å®Œæˆçš„ **â€œprefill + decodeâ€ é˜¶æ®µè¿›è¡Œè§£è€¦å¤„ç†**ï¼Œä»è€Œæé«˜ååé‡ã€å‡å°‘å»¶è¿Ÿï¼Œå°¤å…¶é€‚ç”¨äº**å¤šç”¨æˆ·å¹¶å‘åœºæ™¯**å’Œ**é•¿ä¸Šä¸‹æ–‡è¾“å…¥**ã€‚



åšæ³•ï¼š**å°† prefill é˜¶æ®µå’Œ decode é˜¶æ®µè¿›è¡Œè§£è€¦ã€åˆ†ç¦»ï¼ˆdisaggregateï¼‰å¤„ç†**

- **ä¸åŒè¯·æ±‚çš„ prefill å’Œ decode å¯ä»¥å¹¶å‘æ‰§è¡Œ**ã€‚
- æ¯”å¦‚ï¼š
  - Request A åœ¨ prefill
  - Request Bã€C åŒæ—¶åœ¨ decode
- è¿™æ ·å°±å¯ä»¥æŠŠè®¡ç®—èµ„æºåˆç†åˆ‡åˆ†ï¼Œæé«˜ **ååé‡ï¼ˆtokens/secï¼‰** å’Œé™ä½ **å°¾éƒ¨å»¶è¿Ÿï¼ˆP99 latencyï¼‰**ã€‚



### 2ã€PrefixCaching

æ¦‚å¿µï¼š**Prefix Cachingï¼ˆå‰ç¼€ç¼“å­˜ï¼‰** æ˜¯ä¸€ç§åœ¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æ¨ç†é˜¶æ®µä½¿ç”¨çš„ **åŠ é€ŸæŠ€æœ¯**ï¼Œä¸»è¦ç”¨äºå¤„ç†å¸¦æœ‰ **é™æ€å‰ç¼€ï¼ˆpromptï¼‰** çš„ç”Ÿæˆä»»åŠ¡ï¼Œæ¯”å¦‚ Chatã€æ–‡æ¡£æ‘˜è¦ã€æç¤ºå­¦ä¹ ç­‰ã€‚

æ ¸å¿ƒæ€æƒ³ï¼šå°†è¾“å…¥ä¸­çš„â€œå‰ç¼€éƒ¨åˆ†â€æå‰è®¡ç®—å¥½ï¼Œå¹¶ **ç¼“å­˜ï¼ˆcacheï¼‰å®ƒçš„ Key å’Œ Value**ï¼Œè¿™æ ·åç»­ç”Ÿæˆ token æ—¶å°±ä¸éœ€è¦é‡å¤è®¡ç®—è¿™éƒ¨åˆ†å†…å®¹ã€‚

| åå­—           | å®ƒåšä»€ä¹ˆ                         | åƒä»€ä¹ˆä¸¾ä¾‹                     |
| -------------- | -------------------------------- | ------------------------------ |
| Prefix Caching | æå‰è®°ä½å¼€å¤´çš„å†…å®¹ï¼Œæ–¹ä¾¿åé¢ä½¿ç”¨ | æŠŠæ•…äº‹å¼€å¤´å†™åœ¨å°çº¸æ¡ä¸Šæ–¹ä¾¿ç¿»çœ‹ |
| ä¸ºä»€ä¹ˆè¦ç”¨ï¼Ÿ   | èŠ‚çœæ—¶é—´ï¼Œå†™å¾—å¿«                 | ä¸ç”¨æ¯æ¬¡éƒ½é‡è¯»å¼€å¤´çš„å†…å®¹       |
| å“ªäº›æ—¶å€™ç”¨ï¼Ÿ   | å¼€å¤´ä¸å˜ï¼Œåé¢æ…¢æ…¢æ¥ç€å†™çš„æ—¶å€™   | è€å¸ˆç»™å‡ºé¢˜ç›®ï¼Œè®©ä½ ç»­å†™æ•…äº‹æ—¶   |



### 3ã€Speculative Decoding

**Speculative Decoding**ï¼ˆæ¨æµ‹å¼è§£ç ï¼‰æ˜¯ä¸€ç§ç”¨äº **åŠ é€Ÿå¤§è¯­è¨€æ¨¡å‹æ¨ç†** çš„æ–¹æ³•ï¼Œé€šè¿‡å…ˆè®©ä¸€ä¸ªå°æ¨¡å‹å¿«é€Ÿâ€œçŒœæµ‹â€å‡ºä¸€æ‰¹ tokenï¼Œå†ç”¨å¤§æ¨¡å‹éªŒè¯è¿™æ‰¹ token çš„æœ‰æ•ˆæ€§ï¼Œä»è€Œå‡å°‘å¤§æ¨¡å‹çš„æ¨ç†æ¬¡æ•°ï¼Œæé«˜æ•´ä½“ç”Ÿæˆé€Ÿåº¦ã€‚



ğŸ¨ æƒ³è±¡ä½ åœ¨ç”»å›¾ç”»æ•…äº‹ï¼š

ä½ æœ‰ä¸ªå¥½æœ‹å‹â€”â€”

- å°ç”»å®¶ ğŸ§‘â€ğŸ¨ï¼ˆç”»å¾—å¿«ä½†ä¸å¤ªå‡†ï¼‰
- è€ç”»å®¶ ğŸ‘¨â€ğŸ¨ï¼ˆç”»å¾—æ…¢ä½†å¾ˆå‡†ï¼‰

ä½ è®©ä»–ä»¬å¸®ä½ ç”»æ¼«ç”»ã€‚

âœï¸ ä½ æ€ä¹ˆå®‰æ’å·¥ä½œï¼Ÿ

1. å°ç”»å®¶å…ˆå¿«é€Ÿç”»å‡º4æ ¼æ¼«ç”»çš„è‰å›¾ âœï¸
2. è€ç”»å®¶æ¥æ£€æŸ¥ âœ”ï¸ï¼š
   - å¦‚æœå‰3æ ¼ç”»å¾—ä¸é”™ï¼Œå°±æ¥å—å®ƒä»¬
   - ç¬¬4æ ¼ä¸å¤ªåƒï¼Œé‚£å°±ä»ç¬¬4æ ¼å¼€å§‹é‡ç”»
3. è¿™æ ·ä½ å°±ä¸ç”¨è€ç”»å®¶æ¯ä¸€æ ¼éƒ½ä»å¤´ç”»å•¦ï¼



## 3ï¼‰vLLMè§£è¯»

å‚è€ƒ[çŒ›çŒ¿ -ã€å¤§æ¨¡å‹æ¨ç†/è®¡ç®—åŠ é€Ÿç³»åˆ—ã€‘](https://zhuanlan.zhihu.com/p/654910335)ï¼Œæ¶µç›–å¦‚ä¸‹å†…å®¹ï¼š

- å›¾è§£vLLM v1ç³»åˆ—ï¼šè§£è¯»å·¥ä½œæµç¨‹ä»¥åŠå„ä¸ªæŠ€æœ¯
- vLLMæºç è§£è¯»ç³»åˆ—
- å…¶ä»–ï¼šFlashAttentionã€åˆ†ç¦»å¼æ¨ç†æ¶æ„ç­‰



### å›¾è§£vLLM v1ç³»åˆ—

> å‚è€ƒï¼š[å›¾è§£Vllm V1ç³»åˆ—1ï¼šæ•´ä½“æµç¨‹](https://zhuanlan.zhihu.com/p/1900126076279160869)

Offline Batchingï¼ˆç¦»çº¿æ‰¹å¤„ç†ï¼‰

- é¦–å…ˆè§‚å¯Ÿæ¶æ„å›¾ï¼Œä¸»è¦æœ‰ä¸¤éƒ¨åˆ†process0ä¸ºå®¢æˆ·ç«¯ï¼Œprocess1ä¸ºEngineCoreProcï¼ŒäºŒè€…é—´åŸºäºZMQè¿›è¡Œè¿›ç¨‹é—´çš„æ•°æ®æ”¶å‘ã€‚

  ```
  1ã€vllm v1å°†è¯·æ±‚çš„pre-processå’Œè¾“å‡ºç»“æœçš„post-processä¸å®é™…çš„æ¨ç†è¿‡ç¨‹æ‹†åˆ†åœ¨2ä¸ªä¸åŒçš„è¿›ç¨‹ä¸­(process0, process1)ã€‚
  2ã€Clientè´Ÿè´£è¯·æ±‚çš„pre-processå’Œè¾“å‡ºç»“æœçš„post-processï¼ŒEngineCoreè´Ÿè´£å®é™…çš„æ¨ç†è¿‡ç¨‹ï¼Œä¸åŒè¿›ç¨‹é—´ä½¿ç”¨ZMQæ¥é€šä¿¡æ•°æ®ã€‚
  ```

- å…·ä½“çš„æµç¨‹ï¼šå¯ä»¥ç»“åˆåŸæ–‡å’Œæ¶æ„å›¾ä¸Šæ ‡è®°çš„æµç¨‹å›¾æ¥çœ‹ï¼Œç”±`1ã€add req to`åˆ°`11ã€output until all reqs are finished`ï¼ŒçŒ¿å§å†™çš„å¤ªè¯¦ç»†äº†ã€‚

Online Serving

- é¦–å…ˆè§‚å¯Ÿæ¶æ„å›¾ï¼Œä¸Offline Batchingçš„åŒºåˆ«ä»…åœ¨äºClientä¸­çš„éƒ¨åˆ†ç»†èŠ‚
- å…·ä½“çš„æµç¨‹ï¼š
  - é’ˆå¯¹æ¯ä¸€ä¸ªreqåˆ›å»ºä¸€ä¸ªå¼‚æ­¥é˜Ÿåˆ—
  - ç•¥



> å‚è€ƒï¼š[å›¾è§£Vllm V1ç³»åˆ—2ï¼šExecutor-Workersæ¶æ„](https://zhuanlan.zhihu.com/p/1900613601577899465)

Executoréƒ¨åˆ†ï¼š

- æ¶æ„å›¾é‡ŒEngineCoreProcæ¨¡å—ä¸­ç®¡æ§æ¨¡å‹åˆ†å¸ƒå¼æ¨ç†çš„æ ¸å¿ƒéƒ¨åˆ†
- Executorä¸€å…±æœ‰4ç§ç±»å‹ï¼Œç”±é…ç½®å‚æ•°--distributed-executor-backendå†³å®šï¼Œæ ¹æ®å„è‡ªçš„é€‚ç”¨åœºæ™¯è¿›è¡Œé€‰æ‹©ï¼šmpï¼ˆå•æœºå¤šå¡ï¼‰ã€rayï¼ˆå¤šæœºå¤šå¡ï¼‰ã€uniï¼ˆå•å¡æˆ–Neuronç¯å¢ƒï¼‰ã€external_launcherï¼ˆæƒ³è¦ç”¨è‡ªå®šä¹‰çš„å¤–éƒ¨å·¥å…·åšåˆ†å¸ƒå¼ç®¡ç†ï¼Œå¦‚Slurmï¼‰

Executor -> Workersï¼š

- è§‚å¯Ÿæ¶æ„å›¾ï¼šç•¥

Executorä¸Workeré—´çš„æ•°æ®ä¼ è¾“æœºåˆ¶ï¼Œ

- é‡ç‚¹å…³æ³¨`rpc_broadcast_mq`å’Œ`worker_response_mq`è¿™ä¸¤ä¸ªè¾“å…¥è¾“å‡ºé˜Ÿåˆ—

- æ•´ä½“ä¸Šè¯´ï¼š

  - å½“ä¸€ä¸ªchunkè¿‡æ¥æ—¶ï¼Œæˆ‘ä»¬ä¼šå…ˆæ£€æŸ¥å®ƒçš„å¤§å°ï¼š
    - å¦‚æœ<=10MBï¼Œåˆ™è£…å…¥shmå¯¹åº”çš„æŸœå­ä¸­
    - å¦‚æœ > 10MBï¼Œåˆ™å…ˆåœ¨shmå¯¹åº”çš„æŸœå­ä¸­è®°ä¸Šä¸€ç¬”(buf[0]==1)ï¼Œç„¶åå†é€šè¿‡zmq sokcetå»sendè¿™ä»½æ•°æ®
    - ä»¥ä¸Šè¿‡ç¨‹ä¸åœ¨æ‰€æä¾›çš„ä»£ç æˆªå›¾ä¸­ï¼Œéœ€è¦å¤§å®¶è‡ªè¡Œæ‰¾ç›¸å…³ä»£ç é˜…è¯»

  - æ¥ç€ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®è¿™ä¸ªæŸœå­çš„æ ‡å¿—buf[0]æ˜¯å¦ä¸º1ï¼Œæ¥æ£€æµ‹å¯¹åº”çš„chunkæ˜¯è£…åœ¨æŸœå­é‡Œï¼Œè¿˜æ˜¯é€šè¿‡zmq socketå‘é€äº†ã€‚å¦‚æœæ˜¯å‰è€…ï¼Œé‚£ä¹ˆç›´æ¥ä»shmè¯»ï¼›å¦‚æœæ˜¯åè€…ï¼Œé‚£ä¹ˆå°±é€šè¿‡zmq socketåšreceiveã€‚

  - æœ€åï¼Œå¦‚æœå½“å‰chunkæ˜¯å¤§æ•°æ®ï¼Œè™½ç„¶å®ƒä¸ä¼šè£…åœ¨å¯¹åº”çš„æŸœå­é‡Œï¼Œä½†æˆ‘ä»¬ä¹Ÿä¼šè®¤ä¸ºè¿™ä¸ªæŸœå­å·²ç»è¢«ä½¿ç”¨è¿‡ã€‚è¿™æ ·åä¸€ä¸ªchunkæ¥çš„æ—¶å€™ï¼Œå®ƒä¸ä¼šä½¿ç”¨å½“å‰çš„æŸœå­ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸‹ä¸€ä¸ªå¯ç”¨çš„æŸœå­ã€‚



> å‚è€ƒï¼š[å›¾è§£Vllm V1ç³»åˆ—3ï¼šKV Cacheåˆå§‹åŒ–](https://zhuanlan.zhihu.com/p/1900932850829730567)

TODO



### vLLMæºç è§£è¯»ç³»åˆ—

TODO



# æ¨ç†åŠ é€Ÿæ–¹æ³•

## æé€ŸæŠ€å·§

å‚è€ƒï¼š

- [vLLMæ¨ç†åŠ é€ŸæŒ‡å—ï¼š7ä¸ªæŠ€å·§è®©QPSæå‡30-60%](https://mp.weixin.qq.com/s/opqOwiOkSZeCEksFmz0NIg)
- [vLLM ååé‡ä¼˜åŒ–å®æˆ˜ï¼š10ä¸ªKV-Cacheè°ƒä¼˜æ–¹æ³•è®©tokens/secç¿»å€](https://mp.weixin.qq.com/s/lwPf07KmLUmKyYOeusTX6g)



## å®æˆ˜

çœ‹äº†äº›é¢ç»ï¼Œä¼¼ä¹å¤§å¤šéƒ½æ˜¯è°ƒå‚



# å¿«é€Ÿä¸Šæ‰‹

ç¯å¢ƒé…ç½®ï¼š

```bash
conda create -n vllm310 python=3.10 -y
conda activate vllm310
python -m pip install --upgrade pip
python -m pip install vllm
```

æ¨¡å‹ä¸‹è½½ï¼š

```bash
pip install -U huggingface_hub
echo 'export HF_ENDPOINT=https://hf-mirror.com' >> ~/.bashrc
source ~/.bashrc

conda activate vllm310
hf download Qwen/Qwen3-32B \
  --local-dir Qwen/Qwen3-32B
```

å¯åŠ¨æ¨¡å‹ï¼š

```bash
python -m vllm.entrypoints.openai.api_server   --host 0.0.0.0   --port 8007   --model Qwen/Qwen3-32B   --max-model-len 8000   --tensor-parallel-size 2   --gpu-memory-utilization 0.90   --swap-space 16   --disable-log-requests
```

æµ‹è¯•ï¼š

```bash
curl --location 'http://0.0.0.0:8007/v1/chat/completions' \
  --header 'Content-Type: application/json' \
  --data '{
  "model": "Qwen/Qwen3-32B",
  "messages": [
    {
      "role": "user",
      "content": "ç®€å•è§£é‡Šä¸€ä¸‹é‡å­è®¡ç®—"
    }
  ],
  "temperature": 0.2,
  "stream": true
}'
```

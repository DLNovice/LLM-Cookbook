### lazydocker

参考：

- 官网：https://github.com/jesseduffield/lazydocker
- ubuntu一键安装（梯子缘故，未安装，可以官网下载文件再拷贝）：`curl https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | bash`



### grafana

注意，因为当前环境下grafana、prometheus、node_exporter均为docker部署，所以为了连接正常，需要先创建一个自定义网络：`docker network create monitoring-net`

后续创建各个容器时也会用到。

否则，grafana连接prometheus时会出现connection refused。

当然，采用Docker Compose应该最方便。



官网下载安装包/docker安装

- 官网下载页：https://grafana.com/grafana/download

- 安装方法1：

  ```
  sudo apt-get install -y adduser libfontconfig1 musl
  wget https://dl.grafana.com/enterprise/release/grafana-enterprise_12.0.1_amd64.deb
  sudo dpkg -i grafana-enterprise_12.0.1_amd64.deb
  ```

- 安装方法2：`docker run -d --name=grafana --network monitoring-net -p 3000:3000 grafana/grafana-enterprise:12.0.1-ubuntu`

- 启动容器：`docker start grafana`

- 初始账号和密码均为：admin





### prometheus

官网下载安装包/docker安装

- 官网：https://github.com/prometheus/prometheus

- 安装：`docker run --name prometheus --network monitoring-net --restart=always -d -p 127.0.0.1:9090:9090 prom/prometheus`

- 启动容器：`docker start prometheus`

- （与后续监控node_exporter等相关）修改配置文件相关：https://www.cnblogs.com/alamZ/p/18304869

  - 复制docker内配置文件：`docker cp prometheus:/etc/prometheus/prometheus.yml $PWD`

  - 修改：添加如下内容（不推荐localhost或者127.0.0.1，出现报错）

    ```
    - job_name: "node"
        static_configs:
          - targets: ["192.168.110.33:9100"]
    ```

  - 复制回去：`docker cp $PWD/prometheus.yml prometheus:/etc/prometheus/prometheus.yml`

  - 重启容器：

    ```
    docker stop **
    docker start **
    ```



错误做法：当前环境下失败了，prometheus的docker容器一直显示restarting

- 准备配置文件（与后续监控node_exporter等相关）：

  - 准备配置文件：

    ```
    mkdir /opt/prometheus
    cd /opt/prometheus/
    vim prometheus.yml
    ```

  - 配置文件参考：

    ```
    略
    ```

- 安装及启动：`docker run  -d --name prometheus --restart=always -p 9090:9090 -v /opt/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus`





### node_exporter

官网下载安装包/docker安装（推荐手动安装，因为docker安装的exporter是在容器里面的，从容器里采集机器本机的数据的时候并不完全，有时会导致和实际数据相差较大）

- 官网：https://github.com/prometheus/node_exporter
- 安装及启动：`docker run -d --name node-exporter --net="host" --pid="host" -v "/:/host:ro,rslave" quay.io/prometheus/node-exporter:latest --path.rootfs=/host`
- 启动容器：`docker start node-exporter`
- 验证：访问http://localhost:9100验证是否正常使用，访问http://localhost:9100/metrics查看监控数据
- 配置prometheus + node_exporter：略，上述我们已经修改了prometheus的配置文件，在prometheus界面中搜索up应该能看到



### nvidia_gpu_exporter

官网：https://github.com/utkuozdemir/nvidia_gpu_exporter

示例安装：这里采用二进制文件的方法

```
VERSION=1.3.1
wget https://github.com/utkuozdemir/nvidia_gpu_exporter/releases/download/v${VERSION}/nvidia_gpu_exporter_${VERSION}_linux_x86_64.tar.gz
tar -xvzf nvidia_gpu_exporter_${VERSION}_linux_x86_64.tar.gz
mv nvidia_gpu_exporter /usr/bin
nvidia_gpu_exporter --help

# 启动（先tmux一下）

nvidia_gpu_exporter &
```

修改prometheus配置文件（可以监控多方）：

```
- job_name: "gpu-exporter"
  static_configs:
  	- targets: ['192.168.110.33:9835']
  
  	- targets: ['*****:9835']
```



grafana界面：https://grafana.com/grafana/dashboards/14574-nvidia-gpu-metrics/

可实现多卡监控



### other

在Grafana导入prometheus：由于上述建立了docker网络，这里采用`http://prometheus:9090`即可

在Grafana导入仪表盘：

- 参考：https://grafana.com/grafana/dashboards/1860-node-exporter-full/
- （搜索Node Exporter Full，或者直接采用id 1860）实际上就是在grafana市场上通过下载json文件或者复制id的形式，拿到仪表盘文件，再导入自己的grafana服务中